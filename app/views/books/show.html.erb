<div class="book-show">
  <h1><%= @book.title %></h1>
  <div class="book-details">
    <p><strong>Author:</strong> <%= @book.author %></p>
    <p><strong>Category:</strong> <%= @book.category.name %></p>
    <p><strong>Average rating:</strong> <%= @book.average_rating || "No ratings yet" %></p>
  </div>
  <div class="cover-image-and-description">
    <div class="book-cover">
      <% if @book.image_url.present? %>
        <%= image_tag @book.image_url, alt: "#{@book.title} cover", class: "book-cover" %>
      <% else %>
        <p>No cover image available.</p>
      <% end %>
    </div>
    <div class="description-and-button">
      <% if @description.present? %>
        <p><%= @description %></p>
      <% else %>
        <p>No description available.</p>
      <% end %>
      <% if logged_in? %>
        <% if current_user.library_entries.exists?(book_id: @book.id) %>
          <%= button_to "Remove from My Library",
                  remove_from_library_book_path(@book),
                  method: :delete, class: "btn" %>
        <% else %>
          <%= button_to "Add to My Library",
                  add_to_library_book_path(@book),
                  method: :post, class: "btn" %>
        <% end %>
      <% end %>
    </div>
  </div>
  <hr class="rule">
  <% if logged_in? %>
    <% if @review.persisted? %>
      <p>You have already reviewed this book.</p>
    <% else %>
      <h3>Write a review</h3>
      <% if @review.errors[:rating].any? %>
        <div class="alert">
          <strong>Error:</strong> <%= @review.errors[:rating].first %>
        </div>
      <% end %>
      <%= render "reviews/form", review: @review, book: @book %>
    <% end %>
  <% else %>
    <p class="muted"><%= link_to "Sign in", new_session_path %> to write a review.</p>
  <% end %>
  <hr class="rule">
  <h3 id="reviews">Reviews</h3>
  <% if @reviews.any? %>
    <div class="review-grid">
      <% @reviews.each do |review| %>
        <%= render "reviews/review_card", review: review, show_book: false %>
      <% end %>
    </div>
    <div style="display: flex; flex-direction: column; justify-content: center; align-items: center">
      <p class="muted">Results: <%= @results_start %> - <%= @results_end %> of <%= @reviews_count %></p>
      <div class="review-pagination top-bar">
        <% if @page.positive? %>
          <%= link_to "Back", book_path(@book, page: @page - 1) + "#reviews", class: "btn" %>
        <% else %>
          <span class="btn disabled">Back</span>
        <% end %>
        <% first_pages = [3, @total_pages].min %>
        <% (0...first_pages).each do |p| %>
          <% if p == @page %>
            <span class="btn"><%= p + 1 %></span>
          <% else %>
            <%= link_to p + 1, book_path(@book, page: p) + "#reviews", class: "btn" %>
          <% end %>
        <% end %>
        <% if @total_pages > 3 %>
          <% if @total_pages > 4 %>
            <span class="btn">&hellip;</span>
          <% end %>
          <% last_page = @total_pages - 1 %>
          <% if last_page == @page %>
            <span class="btn"><%= @total_pages %></span>
          <% else %>
            <%= link_to @total_pages, book_path(@book, page: last_page) + "#reviews", class: "btn" %>
          <% end %>
        <% end %>
        <% if @has_next %>
          <%= link_to "Next", book_path(@book, page: @page + 1) + "#reviews", class: "btn" %>
        <% else %>
          <span class="btn disabled">Next</span>
        <% end %>
      </div>
    </div>
  <% else %>
    <p class="muted">No reviews yet.</p>
  <% end %>
</div>
